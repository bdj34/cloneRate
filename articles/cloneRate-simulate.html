<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cloneRate">
<title>Validating growth rate estimates via simulation • cloneRate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Validating growth rate estimates via simulation">
<meta property="og:description" content="cloneRate">
<meta property="og:image" content="https://bdj34.github.io/cloneRate/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cloneRate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cloneRate-dataAnalysis.html">Analysis of human blood data</a>
    <a class="dropdown-item" href="../articles/cloneRate-simulate.html">Validating growth rate estimates via simulation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bdj34/cloneRate/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Validating growth rate estimates via simulation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bdj34/cloneRate/blob/HEAD/vignettes/cloneRate-simulate.Rmd" class="external-link"><code>vignettes/cloneRate-simulate.Rmd</code></a></small>
      <div class="d-none name"><code>cloneRate-simulate.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we’ll walk through how we simulated a birth-death
branching process to validate our growth rate methods. The simulation
procedure is a direct implementation of results by Amaury Lambert in <a href="https://pubmed.ncbi.nlm.nih.gov/29704514/" class="external-link">a recent paper</a>.
We’ll show here that these results allow for extremely fast generation
of a sampled tree of size <span class="math inline">\(n\)</span> from a
birth-death process of time <span class="math inline">\(T\)</span> with
fixed birth and death rates. The key point here is that we don’t have to
simulate this using computationally intensive algorithms (gillespie
etc.); the math provides a shortcut which allows us to generate the
results on a single core in under a second for a tree with 100 tips or
about 8 seconds for a tree with 1000 tips! In R!</p>
<p>The applications of this fast generation of sampled trees are
countless. For us, this results allowed us to simulate thousands of
trees to check our methods for growth rate estimation from phylogenetic
tree reconstruction, which is detailed in <a href="https://www.biorxiv.org/" class="external-link">our recent preprint.</a> We’ll reproduce
this validation here.</p>
<div class="section level3">
<h3 class="unnumbered" id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>First, we’ll have to load the packages we want to use. We’ll be
plotting the trees using the <a href="https://rdrr.io/cran/ape/" class="external-link"><code>ape</code></a> package function
<a href="https://rdrr.io/cran/ape/man/plot.phylo.html" class="external-link"><code>ape::plot.phylo()</code></a>
along with some other <code>ape</code> functions. If you have
<code>cloneRate</code> installed, you already have the <a href="https://rdrr.io/cran/ape/" class="external-link"><code>ape package</code></a>. We’ll
also be using <a href="https://ggplot2.tidyverse.org/" class="external-link"><code>ggplot2</code></a> to make
our plots, which can be installed from CRAN as shown below:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load and attach our package cloneRate</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bdj34/cloneRate" class="external-link">cloneRate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load and attach ape, which will be installed if you've installed cloneRate</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install ggplot2 if necessary, then load and attach it with library()</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>We’ll also set the color palette which we’ll use for most of the
plotting. The palette is taken from <a href="https://davidmathlogic.com/colorblind/#%23000000-%23E69F00-%2356B4E9-%23009E73-%23F0E442-%230072B2-%23D55E00-%23CC79A7" class="external-link">here</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colorPal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#000000"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulating-trees">Simulating trees<a class="anchor" aria-label="anchor" href="#simulating-trees"></a>
</h2>
<p>In this section, we’ll simulate ultrametric and mutation-based trees.
Ultrametric just means that the tips are all the same distance from the
root. In our specific case, the ultrametric trees will have edge lengths
in units of time, so ultrametric means that the tips are sampled at the
same time. Mutation-based trees are those with edge lengths in units of
mutations. Mutation-based trees will typically not be ultrametric,
because there will be some fluctuations in the number of mutations
acquired.</p>
<p>We’ll be generating trees of class <code>phylo</code>, which is a
fairly straightforward encoding of phylogenetic trees in R. The ape
documentation describing the class <code>phylo</code> can be found <a href="http://ape-package.ird.fr/misc/FormatTreeR_24Oct2012.pdf" class="external-link">here.</a></p>
<div class="section level3">
<h3 id="ultrametric-trees">Ultrametric trees<a class="anchor" aria-label="anchor" href="#ultrametric-trees"></a>
</h3>
<p>Let’s start with ultrametric trees. First, let’s simulate a single
tree and have a look at the class <code>phylo</code>. We’ll use the
function <code><a href="../reference/simUltra.html">simUltra()</a></code> from our package to do this, which
simulates an ultrametric tree. We’ll set a birth rate <code>a</code>, a
death rate <code>b</code>, an age for the tree <code>cloneAge</code>,
and the number of sampled tips <code>n</code>. Note that we use
<code>cloneAge</code> instead of <span class="math inline">\(T\)</span>
for the time because <code>T</code> in R means <code>TRUE</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate the tree</span></span>
<span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simUltra.html">simUltra</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">0</span>, cloneAge <span class="op">=</span> <span class="fl">20</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We see that the tree is of class phylo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "phylo"</span></span>
<span></span>
<span><span class="co"># Preview the tree</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Phylogenetic tree with 100 tips and 100 internal nodes.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tip labels:</span></span>
<span><span class="co">#&gt;   t91, t57, t86, t55, t34, t70, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rooted; includes branch lengths.</span></span></code></pre></div>
<p>Again, the best place to get more info about the class
<code>phylo</code> is <a href="http://ape-package.ird.fr/misc/FormatTreeR_24Oct2012.pdf" class="external-link">here.</a>
Our functions for simulating trees will include metadata. Let’s take a
look at the metadata included in the tree.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">metadata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   r a b cloneAge   n runtime_seconds addStem</span></span>
<span><span class="co">#&gt; 1 1 1 0       20 100           0.639    TRUE</span></span></code></pre></div>
<p>We see that the columns are:</p>
<ul>
<li>
<code>r</code>, <code>a</code>, <code>b</code>: The growth rate
params. <code>r</code> is the net growth rate, <code>a</code> is birth
rate and <code>b</code> is death rate, so <code>r=a-b</code>
</li>
<li>
<code>cloneAge</code>: The time that passes, in the same units as
<code>r</code>, <code>a</code>, and <code>b</code>.</li>
<li>
<code>n</code>: The number of samples from the birth-death process,
producing a tree with <code>n</code> tips.</li>
<li>
<code>runtime_seconds</code>: The elapsed time to generate the
tree.</li>
<li>
<code>addStem</code>: Tells us whether the tree has a root edge
preceding the first split. We’ll show the “stem” in plots below.</li>
</ul>
<p>Now let’s plot the tree.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/plot.phylo.html" class="external-link">plot.phylo</a></span><span class="op">(</span><span class="va">tree</span>, direction <span class="op">=</span> <span class="st">"downwards"</span>, show.tip.label <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/axisPhylo.html" class="external-link">axisPhylo</a></span><span class="op">(</span>side <span class="op">=</span> <span class="fl">2</span>, backward <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main<span class="op">=</span><span class="st">"Simulated tree"</span>, ylab<span class="op">=</span><span class="st">"Time"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloneRate-simulate_files/figure-html/plotOne-1.png" width="100%"></p>
<p>In the tree we plotted above, we see that the “stem” is the edge
extending from time 0 to the first split. We call these splits
coalescence events and they’ll be very important for our methods of
growth rate estimation.</p>
<p>Also, we see that the tree is ultrametric, meaning that they all are
sampled at the same time, in this case 20 units of time after the
birth-death process began. As a default, we’ll talk about units of time
in years, but that is arbitrary. Just make sure the units of the growth
rate (per year) are the same as the time units (years).</p>
<p>Let’s apply our growth rate estimates to this tree, seeing if our
estimates are close to the value of <code>r</code> that we used to
generate the tree. We have two functions for estimating the growth rate
of an ultrametric tree, and we’ll compare their performance later
on:</p>
<ul>
<li>
<code><a href="../reference/internalLengths.html">internalLengths()</a></code>: This function sums the edge lengths
of the internal edges of the tree (excluding the stem). We call this sum
<span class="math inline">\(L_i\)</span>. The growth rate is calculated
as <span class="math inline">\(r = L_i / n\)</span> where <span class="math inline">\(n\)</span> is the number of sampled tips.</li>
<li>
<code><a href="../reference/maxLikelihood.html">maxLikelihood()</a></code>: This function uses a maximum
likelihood estimation of the distribution of coalescence times, using
the information about when the tree splits. The distribution of
coalescence times is approximated by a standard logistic distribution
scaled by <span class="math inline">\(1/r\)</span>. Maximizing the
likelihood of the observed coalescence times for the <span class="math inline">\(r\)</span> term gives us our estimate.</li>
</ul>
<p>Both methods are detailed in <a href="https://www.biorxiv.org/" class="external-link">our
recent preprint.</a></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/maxLikelihood.html">maxLikelihood</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="co">#&gt; [1] 1.021494</span></span>
<span></span>
<span><span class="fu"><a href="../reference/internalLengths.html">internalLengths</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="co">#&gt; [1] 1.029506</span></span></code></pre></div>
<p>We know that our actual growth rate is 1, so we can evaluate how our
estimates are doing. One estimate doesn’t really tell us much though.
Let’s try 100. To do this, we just set the <code>nTrees</code> param
equal to 100 in our <code><a href="../reference/simUltra.html">simUltra()</a></code> function. You can
parallelize this process if you have the <code>parallel</code> package
installed by simply setting <code>nCores</code>, but we’ll leave this at
1 for now. By printing the elapsed time, we see that with only one core
it takes a few minutes.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ptm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tree.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simUltra.html">simUltra</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">0</span>, cloneAge <span class="op">=</span> <span class="fl">20</span>, n <span class="op">=</span> <span class="fl">100</span>, nTrees <span class="op">=</span> <span class="fl">500</span>, nCores <span class="op">=</span> <span class="fl">1</span>, addStem <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"elapsed"</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">ptm</span><span class="op">[[</span><span class="st">"elapsed"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 274.123</span></span></code></pre></div>
<p>Let’s apply our methods to these trees. We can input either a single
<code>phylo</code> object, or a list of <code>phylo</code> objects to
our growth rate functions. Either way, it’ll return a
<code>data.frame</code> which each row corresponding to an estimate for
each tree.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resultsMaxLike</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/maxLikelihood.html">maxLikelihood</a></span><span class="op">(</span><span class="va">tree.list</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resultsLengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/internalLengths.html">internalLengths</a></span><span class="op">(</span><span class="va">tree.list</span><span class="op">)</span></span></code></pre></div>
<p>We gave each method 500 trees to estimate, let’s plot these
estimates. Remember that all the input trees had a growth rate of 1, so
we want these estimates to be close to 1. We’ll use ggplot’s density
plot for this:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine for ggplot formatting</span></span>
<span><span class="va">resultsCombined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">resultsLengths</span>, <span class="va">resultsMaxLike</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot, adding a vertical line at r=1 because that's the true growth rate</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">resultsCombined</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">exampleUltraTrees</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Net growth rate estimate (r)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Internal lengths"</span>, <span class="st">"Max. likelihood"</span><span class="op">)</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"#009E73"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloneRate-simulate_files/figure-html/plotEstimates-1.png" width="100%"></p>
<p>Not bad, but we’ll want to test this more formally over a large range
of parameter values. More on that later in this vignette. For now, let’s
shift our attention to mutation trees.</p>
</div>
<div class="section level3">
<h3 id="mutation-trees">Mutation trees<a class="anchor" aria-label="anchor" href="#mutation-trees"></a>
</h3>
<p>There are two ways to generate mutation trees:</p>
<ul>
<li>We can add mutations to a time-based ultrametric tree</li>
<li>We can generate a completely new mutation-based tree</li>
</ul>
<p>Either way, the process of generating mutation trees consists of:</p>
<ul>
<li>Generating an ultrametric, time-based tree. This step is only
required to generate a new tree</li>
<li>For each edge, draw the number of mutations from a poisson
distribution with mean equal to the mutation rate <code>nu</code>
multiplied by the edge length of the time-based tree.</li>
</ul>
<p>Let’s take the ultrametric trees we just generated and convert them
to mutation-based trees. For this, we provide the function
<code><a href="../reference/ultra2mut.html">ultra2mut()</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set mutation rate equal to 10 muts/year for all trees</span></span>
<span><span class="va">mutTree.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ultra2mut.html">ultra2mut</a></span><span class="op">(</span><span class="va">tree.list</span>, nu <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, we can generate a new set of mutation trees using the
function <code><a href="../reference/simMut.html">simMut()</a></code>. We won’t run this because it will take
another few minutes, and we already have the mutation-based trees
generated above.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set params for ultra tree + a mutation rate</span></span>
<span><span class="va">mutTree.list2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simMut.html">simMut</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">0</span>, cloneAge <span class="op">=</span> <span class="fl">20</span>, n <span class="op">=</span> <span class="fl">100</span>, nTrees <span class="op">=</span> <span class="fl">500</span>, nu <span class="op">=</span> <span class="fl">100</span>, nCores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>If we want to estimate the growth rate from a mutation tree, we use
the <code><a href="../reference/sharedMuts.html">sharedMuts()</a></code> function, which works very similarly to
the <code><a href="../reference/internalLengths.html">internalLengths()</a></code> function. However, instead of
counting the internal edge lengths in units of time, the
<code><a href="../reference/sharedMuts.html">sharedMuts()</a></code> function counts the internal/shared mutations
and uses the mutation rate to scale to time. So, if <span class="math inline">\(M_i\)</span> is the number of internal or shared
mutations, <span class="math inline">\(nu\)</span> is the mutation rate,
and <span class="math inline">\(n\)</span> is the number of samples, the
growth rate estimate is <span class="math inline">\(r = M_i /(\nu
n)\)</span>.</p>
<p>Let’s apply the <code><a href="../reference/sharedMuts.html">sharedMuts()</a></code> function to the trees that
we converted to mutation-based. Remember that these mutation-based trees
are generated from the ultrametric trees we applied our functions
<code><a href="../reference/maxLikelihood.html">maxLikelihood()</a></code> and <code><a href="../reference/internalLengths.html">internalLengths()</a></code> to.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resultsShared</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sharedMuts.html">sharedMuts</a></span><span class="op">(</span><span class="va">mutTree.list</span>, nu <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the estimates all together. First, we’ll combine the
data.frames produced. The <code><a href="../reference/sharedMuts.html">sharedMuts()</a></code> function outputs an
additional column corresponding to the mutation rate <code>nu</code>.
Because of this, using rbind on the full data.frames will give an error.
We only want to look at the estimates for now, so we’ll just combine the
necessary columns from each data.frame.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine the columns with the estimates</span></span>
<span><span class="va">colsUse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lowerBound"</span>, <span class="st">"estimate"</span>, <span class="st">"upperBound"</span>, <span class="st">"method"</span><span class="op">)</span></span>
<span><span class="va">resultsAll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">resultsShared</span><span class="op">[</span>,<span class="va">colsUse</span><span class="op">]</span>, <span class="va">resultsCombined</span><span class="op">[</span>,<span class="va">colsUse</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot, adding a vertical line at r=1 because that's the true growth rate</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">resultsAll</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">exampleUltraTrees</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Net growth rate estimate (r)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Internal lengths"</span>, <span class="st">"Max. likelihood"</span>, <span class="st">"Shared Muts."</span><span class="op">)</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">colorPal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">colorPal</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">colorPal</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloneRate-simulate_files/figure-html/plotAll-1.png" width="100%"></p>
<p>It looks like we’re on the right track. From this, I’d say maximum
likelihood looks the best, but 100 trees isn’t that many. We’ll do more
quantiative analysis with more trees now that we have the hang of
it.</p>
</div>
</div>
<div class="section level2">
<h2 id="quantitative-comparisons">Quantitative comparisons<a class="anchor" aria-label="anchor" href="#quantitative-comparisons"></a>
</h2>
<p>In this section, we’ll use our ability to generate trees in order to
test our methods. We’ll focus mainly on the ultrametric trees, noting
that the mutation-based approach based on shared mutations is analogous
to the internal lengths method. We’ll see how well our methods perform,
where they perform well, and where they fail.</p>
<div class="section level3">
<h3 id="max-likelihood-vs--internal-lengths-vs--shared-mutations">Max likelihood vs. internal lengths vs. shared mutations<a class="anchor" aria-label="anchor" href="#max-likelihood-vs--internal-lengths-vs--shared-mutations"></a>
</h3>
<p>We want to know which estimate is the best. We’ll start by making a
quantiative comparison of the 500 estimates we already have from our
simulations in the previous section. 500 trees should be enough to get
an idea of which estimate is most accurate, but we can always simulate
more. We won’t do that here though because it’ll take a bit longer and,
well, we have to stop somewhere.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the RMSE</span></span>
<span><span class="va">groundTruth</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">resultsAll</span>, <span class="va">resultsAll</span><span class="op">$</span><span class="va">method</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">groundTruth</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span>
<span><span class="co">#&gt;    lengths    maxLike sharedMuts </span></span>
<span><span class="co">#&gt;  0.1067887  0.1026797  0.1124074</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the mean</span></span>
<span><span class="va">simMean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">resultsAll</span>, <span class="va">resultsAll</span><span class="op">$</span><span class="va">method</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">simMean</span><span class="op">)</span></span>
<span><span class="co">#&gt;    lengths    maxLike sharedMuts </span></span>
<span><span class="co">#&gt;   1.017819   1.046948   1.017323</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the standard deviation of our estimates</span></span>
<span><span class="va">simSD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">resultsAll</span>, <span class="va">resultsAll</span><span class="op">$</span><span class="va">method</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">simSD</span><span class="op">)</span></span>
<span><span class="co">#&gt;    lengths    maxLike sharedMuts </span></span>
<span><span class="co">#&gt;  0.1053969  0.0914095  0.1111759</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="varying-n">Varying n<a class="anchor" aria-label="anchor" href="#varying-n"></a>
</h3>
</div>
<div class="section level3">
<h3 id="varying-r">Varying r<a class="anchor" aria-label="anchor" href="#varying-r"></a>
</h3>
<p>As we noted before, we can simulate many trees at once using
<code><a href="../reference/simUltra.html">simUltra()</a></code> and <code><a href="../reference/simMut.html">simMut()</a></code>. Here, we’ll use
<code><a href="../reference/simUltra.html">simUltra()</a></code> to generate 100 trees at various growth rates.
We do a similar analysis in Figures 3 and 4 of our preprint</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Brian Johnson, Yubo Shuai, Jason Schweinsberg, Kit Curtius.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
